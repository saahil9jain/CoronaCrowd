<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Corona Crowd</title>
  <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel='stylesheet' href='assets/css/style.css'>

  <script src="https://api.mapbox.com/mapbox-gl-js/v1.9.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v1.9.0/mapbox-gl.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

  <script src="https://cdn.agora.io/sdk/release/AgoraRTCSDK-3.0.2.js"></script>
</head>
<body>
  <header class='topbar'>
    <h1 class='logo'>Corona Crowd</h1>
  </header>

  <div id='map'></div>

  <!-- Channel Modal -->
  <div class="modal fade" id="channelModal" tabindex="-1" role="dialog" aria-labelledby="channelModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Bob's Donuts</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <!-- for joining a channel -->
         <form id="form" class="row col l12 s12">
           <div class="row container col l12 s12">
             <div class="col" style="min-width: 433px; max-width: 443px">
               <div class="card" style="margin-top: 0px; margin-bottom: 0px;">
                 <div class="row card-content" style="margin-bottom: 0px;">
                     <div class="input-field">
                       <label for="appID" class="active">App ID</label>
                       <input type="text" placeholder="App ID" name="appID">
                     </div>
                     <div class="input-field">
                       <label for="channel" class="active">Channel</label>
                       <input type="text" placeholder="channel" name="channel">
                     </div>
                     <div class="input-field">
                       <label for="token" class="active">Token</label>
                       <input type="text" placeholder="token" name="token">
                     </div>
                     <div class="row" style="margin: 0">
                       <div class="col s12">
                       <button class="btn btn-raised btn-primary waves-effect waves-light" id="join">JOIN</button>
                       <!-- <button class="btn btn-raised btn-primary waves-effect waves-light" id="leave">LEAVE</button> -->
                       <!-- <button class="btn btn-raised btn-primary waves-effect waves-light" id="publish">PUBLISH</button> -->
                       <!-- <button class="btn btn-raised btn-primary waves-effect waves-light" id="unpublish">UNPUBLISH</button> -->
                       </div>
                     </div>
                 </div>
               </div>
               <ul class="collapsible card agora-secondary-border" style="margin-top: .4rem; border: 1px ">
                 <li>
                   <div class="collapsible-header agora-secondary-bg">
                     <h8 class="center-align">ADVANCED SETTINGS</h8>
                   </div>
                   <div class="collapsible-body card-content">
                     <div class="row">
                       <div class="col s12">
                         <div class="input-field">
                           <label for="UID" class="active">UID</label>
                           <input type="number" placeholder="UID" name="uid">
                         </div>
                         <div class="input-field">
                           <label for="cameraId" class="active">CAMERA</label>
                           <select name="cameraId" id="cameraId"></select>
                         </div>
                         <div class="input-field">
                           <label for="microphoneId" class="active">MICROPHONE</label>
                           <select name="microphoneId" id="microphoneId"></select>
                         </div>
                         <div class="input-field">
                           <label for="cameraResolution" class="active">CAMERA RESOLUTION</label>
                           <select name="cameraResolution" id="cameraResolution"></select>
                         </div>
                         <div class="row col s12">
                           <div class="row">
                             <label for="mode" class="active">MODE</label>
                           </div>
                           <div class="row">
                             <label>
                               <input type="radio" class="with-gap" name="mode" value="live" checked />
                               <span>live</span>
                             </label>

                             <label>
                               <input type="radio" class="with-gap" name="mode" value="rtc" />
                               <span>rtc</span>
                             </label>
                           </div>
                         </div>
                         <div class="row col s12">
                           <div class="row">
                             <label for="codec" class="active">CODEC</label>
                           </div>
                           <div class="row">
                             <label>
                               <input type="radio" class="with-gap" name="codec" value="h264" checked />
                               <span>h264</span>
                             </label>

                             <label>
                               <input type="radio" class="with-gap" name="codec" value="vp8" />
                               <span>vp8</span>
                             </label>
                           </div>
                         </div>
                       </div>
                     </div>
                 </li>
               </ul>
             </div>
           </div>
         </form>
        
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Back to the map</button>
          <button type="button" class="btn btn-primary">Enter channel</button>
        </div>
      </div>
    </div>
  </div>

  <section class='hero span'>
    <h1>Community in the time of COVID-19</h1>
    <p>In times of quarantine, people all over the world are fighting physical isolation by returning to community spaces in online form.</p>
    <div class='action'>
      <a href="mailto:hi@coronacrowd.fake.website?subject=Host%20a%20crowd%20inquiry&body=Hi!%20I'm%20interested%20in%20hosting%20a%20crowd%20on%20Corona%20Crowd%20and%20would%20love%20to%20learn%20more.%20Can%20you%20send%20me%20some%20details%20on%20how%20I%20can%20register%20a%20crowd%20host%20and%20get%20my%20community%20space%20up%20and%20running%3FThanks!" class="button">
        <span class="material-icons">contact_support</span> Host a crowd</a>
    </div>
    <p id='host-help-text'>If you manage a restaurant, pub, museum, library or other community space – bring the conversation online by creating an immersive space on Corona Crowd!</p>
  </section>
  <hr>
  <section class='span'>
    <h3>What is this?</h3>
    <p>Lots of people are feeling isolated or lonely without the social contact they find at their local pub, library, barbershop, or restaurant. At the same time, cultural centers and businesses are affected due to the lack of patronage caused by global quarantine. </p>
    <p>We wanted to bridge this digital gap by building an authentic digital space for people to spend time together, much as they do in the physical world.</p>
  </section>
  <section class='span'>
    <h3>How does it work?</h3>
    <p>We’ve combined the real-time technologies of the Internet, including technologies like RTC audio streaming, real-time mapping/localization, voice balancing, and spatial awareness.</p>
    <p>This simulates the experience of navigating a crowded space with a few groups of people, and then settling into a conversation you find interesting.</p>
  </section>
  <section class='span'>
    <h3>The fine print</h3>
    <p>We have a zero-tolerance policy towards bullying, harassment, or abuse of any sort on the platform. We have taken some steps to uphold the quality of the community:</p>
    <ol>
      <li>Crowds can only convene during open hours, which are set by community spaces</li>
      <li>A dedicated Crowd Host from the hosting organization is present</li>
      <li>No personal contact information, such as names or phone numbers, is ever revealed to anyone without explicit consent</li>
      <li>People can report any abuse to their Crowd Host at any time using a secure messaging platform </li>
  </section>


  <!-- The core Firebase JS SDK is always required and must be listed first -->
  <script src="https://www.gstatic.com/firebasejs/7.13.0/firebase-app.js"></script>

  <!-- TODO: Add SDKs for Firebase products that you want to use
       https://firebase.google.com/docs/web/setup#available-libraries -->
  <script src="https://www.gstatic.com/firebasejs/7.13.0/firebase-analytics.js"></script>

  <script>
    // Your web app's Firebase configuration
    var firebaseConfig = {
      apiKey: "AIzaSyA-TtymaKaQYS1LiedsCmgdj3kV5Z2TtOo",
      authDomain: "corona-crowd-cf195.firebaseapp.com",
      databaseURL: "https://corona-crowd-cf195.firebaseio.com",
      projectId: "corona-crowd-cf195",
      storageBucket: "corona-crowd-cf195.appspot.com",
      messagingSenderId: "698495134070",
      appId: "1:698495134070:web:5784b0cf5b69ecf9cef257",
      measurementId: "G-94GEBWFH9T"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();

    // Setup Mapbox
    mapboxgl.accessToken = 'pk.eyJ1IjoicmVhY2hneWFuIiwiYSI6ImNqOG9yZzA2ajA2bW0yd3J6djh4NHBucmIifQ.5xzvq2yQS1ZTRgJsKuYKNg';

    var map = new mapboxgl.Map({
      container: 'map', // container id
      style: 'mapbox://styles/mapbox/streets-v11', //stylesheet location
      center: [-100, 40], // starting position
      zoom: 4// starting zoom
    });

    // prepare marker data
    var geojson = {
      type: 'FeatureCollection',
      features: [//{
      //   type: 'Feature',
      //   geometry: {
      //     type: 'Point',
      //     coordinates: [-77.032, 38.913]
      //   },
      //   properties: {
      //     title: 'Crowd (beta 1)',
      //     description: 'Washington, D.C.'
      //   }
      // },
      {
        type: 'Feature',
        geometry: {
          type: 'Point',
          coordinates: [-122.414, 37.776]
        },
        properties: {
          title: "Bob's Donuts",
          description: 'San Francisco, California<div class="action"><a class="button btn-sm button--crowdlaunch" data-toggle="modal" data-target="#channelModal"><span class="material-icons">people_alt</span> Visit</a></div>',
          image: 'assets/img/donuts.jpeg'
        }
      }]
    };

    // add markers to map
    geojson.features.forEach(function(marker) {

      // create a HTML element for each feature
      var el = document.createElement('div');
      el.className = 'map-marker';

      // make a marker for each feature and add to the map
      new mapboxgl.Marker(el)
        .setLngLat(marker.geometry.coordinates)
        .setPopup(new mapboxgl.Popup({ offset: 25}) // add popups
          .setHTML('<img class="thumbnail_image" src="' + marker.properties.image + '">' + '<h5>' + marker.properties.title + '</h5>' + marker.properties.description))
        .addTo(map);

    })

    map.fire('click', { lngLat: [-77.032, 38.913] })


    /* Some map API stuff to use:

    On homepage
    - Markers for active crowds (https://docs.mapbox.com/mapbox-gl-js/example/add-image-generated/)
    - Marker popup on hover (https://docs.mapbox.com/mapbox-gl-js/example/popup-on-hover/)
    - If we want to force people to find spaces in their area? (https://docs.mapbox.com/mapbox-gl-js/example/restrict-bounds/)

    On crowd
    - ...

    */

  </script>

  <!-- Agora scripts -->
  <script src="vendor/jquery.min.js"></script>
  <script src="vendor/materialize.min.js"></script>

  <!-- handle joining a channel -->
  <script type="text/javascript">

    function validator(formData, fields) {
      var keys = Object.keys(formData);
      for (let key of keys) {
        if (fields.indexOf(key) != -1) {
          if (!formData[key]) {
            Toast.error("Please Enter " + key);
            return false;
          }
        }
      }
      return true;
    }

    function serializeformData() {
      var formData = $("#form").serializeArray();
      var obj = {}
      for (var item of formData) {
        var key = item.name;
        var val = item.value;
        obj[key] = val;
      }
      return obj;
    }

    $(function () {
        getDevices(function (devices) {
          devices.audios.forEach(function (audio) {
            $('<option/>', {
              value: audio.value,
              text: audio.name,
            }).appendTo("#microphoneId");
          })
          devices.videos.forEach(function (video) {
            $('<option/>', {
              value: video.value,
              text: video.name,
            }).appendTo("#cameraId");
          })
          resolutions.forEach(function (resolution) {
            $('<option/>', {
              value: resolution.value,
              text: resolution.name
            }).appendTo("#cameraResolution");
          })
          M.AutoInit();
        })

        var fields = ['appID', 'channel'];

        $("#join").on("click", function (e) {
          console.log("join")
          e.preventDefault();
          var params = serializeformData();
          if (validator(params, fields)) {
            join(rtc, params);
          }
        })

        // $("#publish").on("click", function (e) {
        //   console.log("publish")
        //   e.preventDefault();
        //   var params = serializeformData();
        //   if (validator(params, fields)) {
        //     publish(rtc);
        //   }
        // });

        // $("#unpublish").on("click", function (e) {
        //   console.log("unpublish")
        //   e.preventDefault();
        //   var params = serializeformData();
        //   if (validator(params, fields)) {
        //     unpublish(rtc);
        //   }
        // });

        // $("#leave").on("click", function (e) {
        //   console.log("leave")
        //   e.preventDefault();
        //   var params = serializeformData();
        //   if (validator(params, fields)) {
        //     leave(rtc);
        //   }
        // })
      })

    /**
  * rtc: rtc object
  * option: {
  *  mode: string, 'live' | 'rtc'
  *  codec: string, 'h264' | 'vp8'
  *  appID: string
  *  channel: string, channel name
  *  uid: number
  *  token; string,
  * }
 **/
  function join (rtc, option) {
    if (rtc.joined) {
      Toast.error("Your already joined");
      return;
    }

    /**
     * A class defining the properties of the config parameter in the createClient method.
     * Note:
     *    Ensure that you do not leave mode and codec as empty.
     *    Ensure that you set these properties before calling Client.join.
     *  You could find more detail here. https://docs.agora.io/en/Video/API%20Reference/web/interfaces/agorartc.clientconfig.html
    **/
    rtc.client = AgoraRTC.createClient({mode: option.mode, codec: option.codec});

    rtc.params = option;

    // handle AgoraRTC client event
    handleEvents(rtc);

    // init client
    rtc.client.init(option.appID, function () {
      console.log("init success");

      /**
       * Joins an AgoraRTC Channel
       * This method joins an AgoraRTC channel.
       * Parameters
       * tokenOrKey: string | null
       *    Low security requirements: Pass null as the parameter value.
       *    High security requirements: Pass the string of the Token or Channel Key as the parameter value. See Use Security Keys for details.
       *  channel: string
       *    A string that provides a unique channel name for the Agora session. The length must be within 64 bytes. Supported character scopes:
       *    26 lowercase English letters a-z
       *    26 uppercase English letters A-Z
       *    10 numbers 0-9
       *    Space
       *    "!", "#", "$", "%", "&", "(", ")", "+", "-", ":", ";", "<", "=", ".", ">", "?", "@", "[", "]", "^", "_", "{", "}", "|", "~", ","
       *  uid: number | null
       *    The user ID, an integer. Ensure this ID is unique. If you set the uid to null, the server assigns one and returns it in the onSuccess callback.
       *   Note:
       *      All users in the same channel should have the same type (number or string) of uid.
       *      If you use a number as the user ID, it should be a 32-bit unsigned integer with a value ranging from 0 to (232-1).
      **/

      // use firebase id as uid for agora
      rtc.client.join(option.token ? option.token : null, option.channel, option.uid ? +option.uid : null, function (uid) {
        Toast.notice("join channel: " + option.channel + " success, uid: " + uid);
        console.log("join channel: " + option.channel + " success, uid: " + uid);
        console.log("_DB.my_id: " + _DB.my_id);
        rtc.joined = true;

        rtc.params.uid = uid;

        // create local stream
        rtc.localStream = AgoraRTC.createStream({
          streamID: rtc.params.uid,
          audio: true,
          video: false, // no video for now
          screen: false,
          microphoneId: option.microphoneId,
          cameraId: option.cameraId
        })

        // init local stream
        rtc.localStream.init(function () {
          console.log("init local stream success");
          // play stream with html element id "local_stream"
          rtc.localStream.play("local_stream")

          // publish local stream
          publish(rtc);
        }, function (err)  {
          Toast.error("stream init failed, please open console see more detail")
          console.error("init local stream failed ", err);
        })
      }, function(err) {
        Toast.error("client join failed, please open console see more detail")
        console.error("client join failed", err)
      })
    }, (err) => {
      Toast.error("client init failed, please open console see more detail")
      console.error(err);
    });
  }

  // function publish (rtc) {
  //   if (!rtc.client) {
  //     Toast.error("Please Join Room First");
  //     return;
  //   }
  //   if (rtc.published) {
  //     Toast.error("Your already published");
  //     return;
  //   }
  //   var oldState = rtc.published;

  //   // publish localStream
  //   rtc.client.publish(rtc.localStream, function (err) {
  //     rtc.published = oldState;
  //     console.log("publish failed");
  //     Toast.error("publish failed")
  //     console.error(err);
  //   })
  //   Toast.info("publish")
  //   rtc.published = true
  // }

  // function unpublish (rtc) {
  //   if (!rtc.client) {
  //     Toast.error("Please Join Room First");
  //     return;
  //   }
  //   if (!rtc.published) {
  //     Toast.error("Your didn't publish");
  //     return;
  //   }
  //   var oldState = rtc.published;
  //   rtc.client.unpublish(rtc.localStream, function (err) {
  //     rtc.published = oldState;
  //     console.log("unpublish failed");
  //     Toast.error("unpublish failed");
  //     console.error(err);
  //   })
  //   Toast.info("unpublish")
  //   rtc.published = false;
  // }

  // function leave (rtc) {
  //   if (!rtc.client) {
  //     Toast.error("Please Join First!");
  //     return;
  //   }
  //   if (!rtc.joined) {
  //     Toast.error("You are not in channel");
  //     return;
  //   }
  //   /**
  //    * Leaves an AgoraRTC Channel
  //    * This method enables a user to leave a channel.
  //    **/
  //   rtc.client.leave(function () {
  //     // stop stream
  //     rtc.localStream.stop();
  //     // close stream
  //     rtc.localStream.close();
  //     while (rtc.remoteStreams.length > 0) {
  //       var stream = rtc.remoteStreams.shift();
  //       var id = stream.getId();
  //       stream.stop();
  //       removeView(id);
  //     }
  //     rtc.localStream = null;
  //     rtc.remoteStreams = [];
  //     rtc.client = null;
  //     console.log("client leaves channel success");
  //     rtc.published = false;
  //     rtc.joined = false;
  //     Toast.notice("leave success");
  //   }, function (err) {
  //     console.log("channel leave failed");
  //     Toast.error("leave success");
  //     console.error(err);
  //   })
  // }


  </script>
</body>
</html>
